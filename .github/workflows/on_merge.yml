name: Production Image Processing (Merge)

on:
  push:
    branches:
      - main
    paths:
      - 'images/**'

env:
  AWS_REGION: us-east-1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }} 
  S3_BUCKET: ${{ secrets.S3_BUCKET }}
  DYNAMODB_TABLE: prod_results

jobs:
  upload-to-prod:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Find changed images
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            images/**/*.jpg
            images/**/*.jpeg
            images/**/*.png
      
      - name: Upload images to S3 Production
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Uploading images to Production environment (rekognition-input/prod/)"
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            echo "Uploading: $filename"
            aws s3 cp "$file" "s3://${S3_BUCKET}/rekognition-input/prod/${filename}" \
              --metadata "environment=prod,branch=main,commit-sha=${GITHUB_SHA}"
            echo "Uploaded to s3://${S3_BUCKET}/rekognition-input/prod/${filename}"
          done
      
      - name: Wait for Lambda processing
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Waiting 10 seconds for Lambda to process images..."
          sleep 10
      
      - name: Validate DynamoDB Results
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Validating results in DynamoDB table: ${DYNAMODB_TABLE}"
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            s3_key="rekognition-input/prod/${filename}"
            
            echo ""
            echo "Checking for results: ${s3_key}"
            
            # Query DynamoDB for the item
            result=$(aws dynamodb get-item \
              --table-name "${DYNAMODB_TABLE}" \
              --key "{\"filename\": {\"S\": \"${s3_key}\"}}" \
              --region "${AWS_REGION}" \
              2>&1)
            
            if echo "$result" | grep -q "Item"; then
              echo "Results found in DynamoDB"
              
              # Extract and display label count
              label_count=$(echo "$result" | jq -r '.Item.label_count.N // "0"')
              echo "Label count: ${label_count}"
              
              # Display labels
              echo "Labels detected:"
              echo "$result" | jq -r '.Item.labels.L[]? | "    - \(.M.Name.S): \(.M.Confidence.N)%"'
              
            else
              echo "Warning: Results not found in DynamoDB yet"
              echo "This may indicate the Lambda function hasn't processed the image yet"
              exit 1
            fi
          done
          
          echo ""
          echo "========================================="
          echo "Production validation complete!"
          echo "All images processed successfully"
          echo "========================================="
      
      - name: Create deployment summary
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Location:** \`rekognition-input/prod/\`" >> $GITHUB_STEP_SUMMARY
          echo "**DynamoDB Table:** \`${DYNAMODB_TABLE}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images Processed" >> $GITHUB_STEP_SUMMARY
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            echo "- \`${filename}\`" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All images uploaded and analyzed successfully via Lambda function." >> $GITHUB_STEP_SUMMARY